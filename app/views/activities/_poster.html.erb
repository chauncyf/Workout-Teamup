<%
  @isJoined = logged_in?
  if (@isJoined)
    @join = activity.get_participation_by_user_id(current_user_id).first
    @isJoined = @isJoined && !@join.nil?
  end
  show_comment = false if local_assigns[:show_comment].nil?

%>

<div class="card shadow mb-3 poster">
  <div class="card-header px-3 py-2 text-white material-head-<%= activity.theme_color %>">
    <div class="row justify-content-between">
      <div class="col col-auto card-title m-0">
        <ul class="list-inline mb-1">
          <li class="list-inline-item align-middle dropdown card-starter-avatar" data-avatar-pop="<%= activity.starter.id %>" data-toggle="dropdown">
            <%= avatar_for(activity.starter) %>
            <div class="dropdown-menu profile-dropdown p-0"> ...</div>
          </li>
          <li class="list-inline-item align-middle">
            <ul class="list-unstyled">
              <li class="activity-starter-name"><%= activity.starter.user_name %></li>
              <li class="activity-update-date"><%= time_ago_in_words activity.updated_at %> ago</li>
            </ul>
          </li>
        </ul>
      </div>

      <div class="col col-auto card-title card-title-button text-right m-0">
        <% if !logged_in? %>
          <%= link_to "", login_path, {remote: true, 'data-toggle': "modal", 'data-target': "#login", class: "fas fa-ellipsis-v text-white"} %>
        <% else %>
          <% if @isJoined %>
            <div class="dropdown">
              <a class="fas fa-check" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></a>
              <div class="dropdown-menu dropdown-menu-right shadow-lg" aria-labelledby="dropdownMenuButton">
                <%= link_to "Leave Activity", "/leave_activity/#{activity.id}", remote: true, class: "dropdown-item", method: :post %>
              </div>
            </div>
          <% else %>
            <%= link_to "", "/join_activity/#{activity.id}", remote: true, class: "fas fa-plus", method: :post %>
          <% end %>
        <% end %>
      </div>
    </div>

    <div class="card-title card-title-date m-0">
      <i class="fas fa-calendar"></i>
      <%= activity.activity_date.strftime("%b %d, %a %H:%M") %>
    </div>
    <div class="card-title card-title-place m-0">
      <i class="fas fa-map-marker-alt"></i>
      <%= activity.place %>
    </div>
  </div>

  <div class="card-body p-3 material-body-<%= activity.theme_color %> ">
    <%= activity.content %>
  </div>

  <div class="card-footer bg-transparent px-3 pt-0 pb-2 material-footer-<%= activity.theme_color %>">
    <div class="row align-items-center">
      <% if @isJoined %>
        <div class="col-auto rate-star" data-raty="true"
             <%= @join.rating != 0 ? "data-readonly='true'" : "" %>
             data-id="<%= @join.id %>"
             data-score="<%= @join.rating %>">
        </div>
      <% end %>

      <div class="col text-right comment_box" data-id="<%= activity.id %>">
        <% if activity.liked?(current_user_id) %>
          <a class="like mr-1"><i class="fa fa-heart"></i></a>
        <% else %>
          <a class="like mr-1"><i class="far fa-heart"></i></a>
        <% end %>
        <a class="comment"><i class="far fa-comment"></i></a>
      </div>
    </div>
    <% if show_comment %>
      <div class="reviews card">

        <div class="card-body">
          <h5 class="card-title">reviews</h5>
          <ul class="list-group list-group-flush">
            <% activity.comments_list.each do |comment| %>
              <div class="list-group-item list-group-item-action flex-column align-items-start">
                <div class="d-flex w-100 justify-content-between">
                  <h5 class="mb-1"><%= avatar_for(comment.user) %><%= comment.user.user_name %>:</h5>
                  <small><%= time_ago_in_words comment.updated_at %> ago</small>
                </div>
                <p class="mb-1">
                  <%= comment.content %>
                </p>
                <small><%= comment.user.motto %></small>
              </div>
            <% end %>
          </ul>
          <div class="input-group comment-input-group">

            <textarea placeholder="Enter your comment here" class="form-control" aria-label="With textarea"></textarea>
            <div class="input-group-append">
              <button class="btn btn-outline-secondary comment_submit"
                      data-id="<%= activity.id %>"
                      type="button">submit
              </button>
            </div>
          </div>

        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
    ratyAll()// make sure every raty is transformed
</script>